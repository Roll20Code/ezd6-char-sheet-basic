<link rel="stylesheet" href="ezd6-basic.css" />

<div class="sheet-outer-container">
    <div class="sheet-inner-container sheet-flex-col sheet-col-gap">
        <div class="sheet-flex-row sheet-flex-centered">
            <div class="sheet-ezd6-logo"></div>
            <h3>Core Sheet</h3>
        </div>

        <div class="sheet-character-sheet sheet-row-gap ${buttonOrientation}">
            <div class="sheet-flex-col sheet-col-gap">
                <div class="sheet-flex-col sheet-border-group">
                    <div class="sheet-input-field">
                        <label for="character_name">Name:</label>
                        <input id="character_name" type="text" name="attr_character_name" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="species">Species:</label>
                        <input id="species" type="text" name="attr_character_species" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="path">Hero Path:</label>
                        <input id="path" type="text" name="attr_character_hero_path" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="aspect_1">Aspect 1:</label>
                        <input id="aspect_1" type="text" name="attr_character_aspect_1" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="aspect_1">Aspect 2:</label>
                        <input id="aspect_1" type="text" name="attr_character_aspect_2" />
                    </div>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="hero_path_features">Hero Path Features:</label>
                    <textarea id="hero_path_features" name="attr_character_hero_path_features" rows="4"
                        cols="100"></textarea>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="magick" title="Sorcery Circle(s), etc.">Magick:</label>
                    <textarea id="magick" name="attr_character_magick" rows="4" cols="100"></textarea>
                </div>
            </div>

            <div class="sheet-flex-col sheet-col-gap" style="align-content: start;">
                <div class="sheet-flex-col sheet-flex-centered sheet-border-group sheet-col-gap"
                    style="padding: 4px 4px !important;">
                    <div class="sheet-flex-row sheet-flex-centered sheet-row-gap">
                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="health" style="text-align: center;">Health:</label>
                            <input id="health" class="sheet-single-digit" type="number" name="attr_character_health" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="karma" style="text-align: center;">Karma:</label>
                            <input id="karma" class="sheet-single-digit" type="number" name="attr_character_karma" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="armor_save" style="text-align: center;"> Armor Save:</label>
                            <input id="armor_save" class="sheet-single-digit" type="number" name="attr_armor_save" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="hero_die" style="text-align: center;">Hero Die:</label>
                            <input id="hero_die" class="sheet-single-digit" type="number" name="attr_hero_die" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="miraculous_save" style="text-align: center;">Miraculous Save:</label>
                            <input id="miraculous_save" class="sheet-single-digit" type="number"
                                name="attr_miraculous_save" />
                        </div>
                    </div>

                    <div class="sheet-flex-col sheet-flex-centered">
                        <label for="description"
                            style="font-size: 1rem; line-height: 1.2rem; margin-bottom: 2px !important;">Description:</label>
                        <textarea id="description" name="attr_character_description" rows="3" cols="100"
                            style="height: 64px !important;"></textarea>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="inclinations">Inclinations:</label>
                    <textarea id="inclinations" name="attr_character_inclinations" rows="4" cols="100"></textarea>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="equipment" title="Wealth, Weapons, Armor, Gear, etc.">Equipment:</label>
                    <textarea id="equipment" name="attr_character_equipment" rows="4" cols="100"></textarea>
                </div>
            </div>

            <div class="sheet-flex-col sheet-col-gap sheet-button-section">
                <div class="sheet-flex-col sheet-border-group">
                    <button type="roll" name="roll_action"
                        value="&{template:action} {{name=Action}} {{Roll=[[1d6!k1]]}}">Action</button>

                    <div class="sheet-flex-row" style="justify-content: space-between;">
                        <button type="roll" name="roll_actionBoon"
                            value="&{template:action} {{name=Action w/Boon}} {{Roll=[[2d6!kh1]]}}">w/Boon</button>
                        <button type="roll" name="roll_actionBane"
                            value="&{template:action} {{name=Action w/Bane}} {{Roll=[[2d6!kl1]]}}">w/Bane</button>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-border-group">
                    <button type="action" name="act_attack">Attack</button>

                    <div class="sheet-flex-row" style="justify-content: space-between;">
                        <button type="action" name="act_attackBoon">w/Boon</button>
                        <button type="roll" name="roll_attackWBane"
                            value="&{template:attack} {{name=Attack w/Bane}} {{Roll=[[2d6!kl1]]}}">w/Bane</button>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                    <div class="sheet-flex-row sheet-row-gap">
                        <button type="roll" name="roll_d6" value="&{template:action} {{name=1D6}} {{Roll=[[1d6]]}}"
                            class="sheet-die">1d6</button>
                        <button type="roll" name="roll_d6X" value="&{template:action} {{name=1D6!}} {{Roll=[[1d6!]]}}"
                            class="sheet-die">1d6!</button>
                        <button type="roll" name="roll_2d6" value="&{template:action} {{name=2D6}} {{Roll=[[2d6k1]]}}"
                            class="sheet-die">2d6</button>
                        <button type="roll" name="roll_2d6X"
                            value="&{template:action} {{name=2D6!}} {{Roll=[[2d6!k1]]}}" class="sheet-die">2d6!</button>
                    </div>

                    <div class="sheet-flex-row sheet-row-gap">
                        <button type="roll" name="roll_3d6" value="&{template:action} {{name=3D6}} {{Roll=[[3d6k1]]}}"
                            class="sheet-die">3d6</button>
                        <button type="roll" name="roll_3d6X"
                            value="&{template:action} {{name=3D6!}} {{Roll=[[3d6!k1]]}}" class="sheet-die">3d6!</button>
                        <button type="roll" name="roll_4d6" value="&{template:action} {{name=4D6}} {{Roll=[[4d6k1]]}}"
                            class="sheet-die">4d6</button>
                        <button type="roll" name="roll_4d6X"
                            value="&{template:action} {{name=4D6!}} {{Roll=[[4d6!k1]]}}" class="sheet-die">4d6!</button>
                    </div>

                    <div class="sheet-flex-row sheet-row-gap">
                        <button type="roll" name="roll_5d6" value="&{template:action} {{name=5D6}} {{Roll=[[5d6k1]]}}"
                            class="sheet-die">5d6</button>
                        <button type="roll" name="roll_5d6X"
                            value="&{template:action} {{name=5D6!}} {{Roll=[[5d6!k1]]}}" class="sheet-die">5d6!</button>
                        <button type="roll" name="roll_6d6" value="&{template:action} {{name=6D6}} {{Roll=[[6d6k1]]}}"
                            class="sheet-die">6d6</button>
                        <button type="roll" name="roll_6d6X"
                            value="&{template:action} {{name=6D6!}} {{Roll=[[6d6!k1cs>2]]}}"
                            class="sheet-die">6d6!</button>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-border-group sheet-col-gap">
                    <label>Sheet Options:</label>

                    <select name="attr_buttonOrientation" style="width: 172px !important;">
                        <option value="sheet-button-orientation-left">Buttons Left</option>
                        <option value="sheet-button-orientation-right">Buttons Right</option>
                    </select>

                    <select name="attr_backgroundImage" style="width: 172px !important;">
                        <option value="">No Background</option>
                        <option value="sheet-border-line">Border</option>
                        <option value="sheet-background-1">Background 1</option>
                        <option value="sheet-background-2">Background 2</option>
                        <option value="sheet-background-3">Background 3</option>
                        <option value="sheet-background-4">Background 4</option>
                        <option value="sheet-background-5">Background 5</option>
                        <option value="sheet-background-6">Background 6</option>
                        <option value="sheet-background-7">Background 7</option>
                        <option value="sheet-background-8">Background 8</option>
                        <option value="sheet-background-9">Background 9</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<rolltemplate class="sheet-rolltemplate-action">
    <h3>{{name}}: {{Roll}}</h3>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-attack">
    <h3>{{name}}: {{computed::Roll}}</h3>
</rolltemplate>

<script type="text/worker">
    const outerContainer = $20('div.sheet-outer-container');
    const innerContainer = $20('div.sheet-inner-container');
    const characterSheet = $20('div.sheet-character-sheet');

    const buttonOrientations = [
        'sheet-button-orientation-left',
        'sheet-button-orientation-right'
    ];

    const backgroundImageClasses = [
        '',
        'sheet-border-line',
        'sheet-background-1',
        'sheet-background-2',
        'sheet-background-3',
        'sheet-background-4',
        'sheet-background-5',
        'sheet-background-6',
        'sheet-background-7',
        'sheet-background-8',
        'sheet-background-9',
    ]

    const clearBackgroundImage = () => backgroundImageClasses.forEach((imageClass) => {
        outerContainer.removeClass(imageClass);
    });

    const clearButtonOrientation = () => buttonOrientations.forEach((orientationClass) => {
        characterSheet.removeClass(orientationClass);
    });

    const rollAttack = (boon = false) => startRoll(
        `&{template:attack} {{name=Attack${boon ? ' w/Boon' : ''}}} {{Roll=[[${boon ? 2 : 1}d6!kh1]]}}`,
        (roll) => {
            const dice = [...roll.results.Roll.dice];
            const count = dice.length;
            
            const native = [];
            const additional = [];

            while (dice.length > 0) {
                let current = dice.shift();
                native.push(current);

                while (current === 6 && dice.length > 0) {
                    current = dice.shift();
                    additional.push(current);
                }
            }
            
            native.sort((a, b) => (b - a));
            
            finishRoll(roll.rollId, { Roll: [native[0], ...additional] });
        }
    );

    on('sheet:opened', () => {
        getAttrs(['buttonOrientation', 'backgroundImage'], (data) => {
            clearButtonOrientation();
            characterSheet.addClass(data.buttonOrientation);

            clearBackgroundImage();
            outerContainer.addClass(data.backgroundImage);
        });
    });

    on('clicked:attackBoon', () => rollAttack(true));
    on('clicked:attack', () => rollAttack());

    on('change:buttonOrientation', (evt) => {
        const { previousValue, newValue } = evt;
        
        characterSheet.removeClass(previousValue);
        characterSheet.addClass(newValue);
    });

    on('change:backgroundImage', (evt) => {
        const { previousValue, newValue } = evt;

        outerContainer.removeClass(previousValue);
        outerContainer.addClass(newValue);
    });
</script>