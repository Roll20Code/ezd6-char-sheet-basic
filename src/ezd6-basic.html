<link rel="stylesheet" href="ezd6-basic.css" />

<div class="sheet-outer-container">
    <div class="sheet-inner-container sheet-flex-col sheet-col-gap">
        <div class="sheet-flex-row sheet-row-gap sheet-flex-centered">
            <div class="sheet-flex-row sheet-row-gap sheet-flex-centered" style="flex-grow: 1;">
                <div class="sheet-ezd6-logo"></div>
                <h3>Core Sheet</h3>
            </div>

            <button class="help-toggle" type="action" name="act_help-open">
                <span class="pictos-icon">?</span>
            </button>
        </div>

        <div class="help-modal hidden">
            <div class="sheet-flex-col sheet-col-gap ${backgroundImage}">
                <div>
                    <div class="sheet-flex-row sheet-flex-centered" style="margin-bottom: 4px;">
                        <div class="sheet-flex-row">
                            <div class="sheet-ezd6-logo"></div>
                            <h3>Core Sheet: Help</h3>
                        </div>

                        <button type="action" name="act_help-close"
                            style="border: none; background-color: rgba(0, 0, 0, 0);">
                            <span class="pictos-icon">*</span>
                        </button>
                    </div>

                    <div class="help-body">
                        <div class="sheet-border-group">
                            <h4>Welcome!</h4>
                            <p>
                                Some titles have a tooltip that will appear when you hover your mouse over
                                them.
                            </p>

                            <p>
                                Dice Notation: 1d6 means, roll 1 six-sided die. When you see an exclaimation
                                point, like 1d6!, this means that the die will "explode", which means you
                                get an additional die rolled.

                                However, in all rolls (except Attack) for EZD6, only the highest die is
                                displayed and used. You can hover your mouse cursor over the result to see
                                all the dice rolls.
                            </p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Dice Roll Buttons:</h4>
                            <h6>D6, 2D6, 3D6, 4D6, 5D6, 6D6</h6>
                            <h6>D6!, 2D6!, 3D6!, 4D6!, 5D6!, 6D6!</h6>
                            <p>
                                These are just plain and exploding rolls that are presented in an EZD6 format.
                            </p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Buttons Right/Left Dropdown:</h4>
                            <p>
                                This lets you configure which side the "Buttons" column is positioned, left
                                or right side of the sheet.
                            </p>
                            <select name="attr_buttonOrientation" style="width: 172px !important;">
                                <option value="sheet-button-orientation-left">Buttons Left</option>
                                <option value="sheet-button-orientation-right">Buttons Right</option>
                            </select>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Background Dropdown:</h4>
                            <p>This lets you configure the sheet background. Possible options are:</p>
                            <ul>
                                <li><span style="font-weight: bold;">No Background</span>: No background
                                    images or borders.</li>
                                <li><span style="font-weight: bold;">Border</span>: Just a clean border, no
                                    background image.</li>
                                <li><span style="font-weight: bold;">Background (1-9)</span>: Any of 9
                                    beautiful background images by Mathew Halstead.</li>
                            </ul>
                            <select name="attr_backgroundImage" style="width: 172px !important;">
                                <option value="">No Background</option>
                                <option value="sheet-border-line">Border</option>
                                <option value="sheet-background-1">Background 1</option>
                                <option value="sheet-background-2">Background 2</option>
                                <option value="sheet-background-3">Background 3</option>
                                <option value="sheet-background-4">Background 4</option>
                                <option value="sheet-background-5">Background 5</option>
                                <option value="sheet-background-6">Background 6</option>
                                <option value="sheet-background-7">Background 7</option>
                                <option value="sheet-background-8">Background 8</option>
                                <option value="sheet-background-9">Background 9</option>
                            </select>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Credits:</h4>
                            <p>
                                First, let's thank DM_Scotty for creating one of the best TT RPGs available
                                today!
                            </p>
                            <ul>
                                <li><span style="font-weight: bold;">John Wakley</span>: Code and Design.
                                </li>
                                <li><span style="font-weight: bold;">Mathew Halstead</span>: Art and Design.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sheet-character-sheet sheet-row-gap ${buttonOrientation}">
            <div class="sheet-flex-col sheet-col-gap">
                <div class="sheet-flex-col sheet-border-group">
                    <div class="sheet-input-field">
                        <label for="character_name">Name:</label>
                        <input id="character_name" type="text" name="attr_character_name" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="species">Species:</label>
                        <input id="species" type="text" name="attr_character_species" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="path">Hero Path:</label>
                        <input id="path" type="text" name="attr_character_hero_path" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="aspect_1">Aspect 1:</label>
                        <input id="aspect_1" type="text" name="attr_character_aspect_1" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="aspect_1">Aspect 2:</label>
                        <input id="aspect_1" type="text" name="attr_character_aspect_2" />
                    </div>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="hero_path_features">Hero Path Features:</label>
                    <textarea id="hero_path_features" class="small" name="attr_character_hero_path_features" rows="4"
                        cols="100"></textarea>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="magick" title="Sorcery Circle(s), Scrolls, Potions, etc...">Magick:</label>
                    <textarea id="magick" class="small" name="attr_character_magick" rows="4" cols="100"></textarea>
                </div>
            </div>

            <div class="sheet-flex-col sheet-col-gap" style="align-content: start;">
                <div class="sheet-flex-col sheet-flex-centered sheet-border-group sheet-col-gap"
                    style="padding: 4px 4px !important;">
                    <div class="sheet-flex-row sheet-flex-centered sheet-row-gap">
                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="health" style="text-align: center;">Health:</label>
                            <input id="health" class="sheet-single-digit" type="number" name="attr_character_health" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="karma" style="text-align: center;">Karma:</label>
                            <input id="karma" class="sheet-single-digit" type="number" name="attr_character_karma" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="armor_save" style="text-align: center;"> Armor Save:</label>
                            <input id="armor_save" class="sheet-single-digit" type="number" name="attr_armor_save" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="hero_die" style="text-align: center;">Hero Die:</label>
                            <input id="hero_die" class="sheet-single-digit" type="number" name="attr_hero_die" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="miraculous_save" style="text-align: center;">Miraculous Save:</label>
                            <input id="miraculous_save" class="sheet-single-digit" type="number"
                                name="attr_miraculous_save" />
                        </div>
                    </div>

                    <div class="sheet-flex-col sheet-flex-centered">
                        <label for="description"
                            style="font-size: 1rem; line-height: 1.2rem; margin-bottom: 2px !important;">
                            Description (Looks, Demeanor, Quirks, Flaws):
                        </label>
                        <textarea id="description" class="small" name="attr_character_description" rows="3" cols="100"
                            style="height: 64px !important;"></textarea>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="inclinations">Inclinations:</label>
                    <textarea id="inclinations" class="small" name="attr_character_inclinations" rows="4"
                        cols="100"></textarea>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="equipment" title="Wealth, Weapons, Armor, Gear, etc.">Equipment:</label>
                    <textarea id="equipment" class="small" name="attr_character_equipment" rows="4"
                        cols="100"></textarea>
                </div>
            </div>

            <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                <button class="dice-roll" data-count="1" data-explode="false">1D6</button>
                <button class="dice-roll" data-count="2" data-explode="false">2D6</button>
                <button class="dice-roll" data-count="3" data-explode="false">3D6</button>
                <button class="dice-roll" data-count="4" data-explode="false">4D6</button>
                <button class="dice-roll" data-count="5" data-explode="false">5D6</button>
                <button class="dice-roll" data-count="6" data-explode="false">6D6</button>
                <br />
                <button class="dice-roll" data-count="1" data-explode="true">1D6!</button>
                <button class="dice-roll" data-count="2" data-explode="true">2D6!</button>
                <button class="dice-roll" data-count="3" data-explode="true">3D6!</button>
                <button class="dice-roll" data-count="4" data-explode="true">4D6!</button>
                <button class="dice-roll" data-count="5" data-explode="true">5D6!</button>
                <button class="dice-roll" data-count="6" data-explode="true">6D6!</button>
                <br />

                <button class="notes-toggle" type="action" name="act_notes-open">Notes</button>

                <div class="notes-modal hidden">
                    <div class="sheet-flex-col ${backgroundImage}">
                        <div class="sheet-flex-col">
                            <div class="sheet-flex-row sheet-flex-centered" style="margin-bottom: 4px;">
                                <div class="sheet-flex-row">
                                    <div class="sheet-ezd6-logo"></div>
                                    <h3>Core Sheet: Notes</h3>
                                </div>

                                <button type="action" name="act_notes-close"
                                    style="border: none; background-color: rgba(0, 0, 0, 0);">
                                    <span class="pictos-icon">*</span>
                                </button>
                            </div>

                            <div class="notes-body sheet-border-group" style="flex-grow: 1;">
                                <textarea class="large" name="attr_notes" rows="4" cols="200"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<rolltemplate class="sheet-rolltemplate-dice">
    <h3>{{name}}</h3>

    {{computed::roll0}}

    {{#roll1}}
    &nbsp;|&nbsp;&nbsp;{{computed::roll1}}
    {{/roll1}}

    {{#roll2}}
    &nbsp;|&nbsp;&nbsp;{{computed::roll2}}
    {{/roll2}}

    {{#roll3}}
    &nbsp;|&nbsp;&nbsp;{{computed::roll3}}
    {{/roll3}}

    {{#roll4}}
    &nbsp;|&nbsp;&nbsp;{{computed::roll4}}
    {{/roll4}}

    {{#roll5}}
    &nbsp;|&nbsp;&nbsp;{{computed::roll5}}
    {{/roll5}}
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-dice-explode">
    <h3>{{name}}</h3>

    <p>
        {{computed::roll0}}
        {{#rollGreater() roll0 5}}
        <span style="font-family: 'Pictos Custom';">t&nbsp;</span>{{computed::expl0}}
        {{/rollGreater() roll0 5}}

        {{^roll1}}
    </p>{{/roll1}}

    {{#roll1}}
    {{#rollGreater() roll0 5}}</p>
    <p>{{/rollGreater() roll0 5}}

        {{#^rollGreater() roll0 5}}
        {{#rollGreater() roll1 5}}</p>
    <p>{{/rollGreater() roll1 5}}
        {{#^rollGreater() roll1 5}}&nbsp;|&nbsp;{{/^rollGreater() roll1 5}}
        {{/^rollGreater() roll0 5}}

        {{computed::roll1}}

        {{#rollGreater() roll1 5}}
        <span style="font-family: 'Pictos Custom';">t&nbsp;</span>{{computed::expl1}}
        {{/rollGreater() roll1 5}}
        {{/roll1}}

        {{^roll2}}
    </p>{{/roll2}}

    {{#roll2}}
    {{#rollGreater() roll1 5}}</p>
    <p>{{/rollGreater() roll1 5}}

        {{#^rollGreater() roll1 5}}
        {{#rollGreater() roll2 5}}</p>
    <p>{{/rollGreater() roll2 5}}
        {{#^rollGreater() roll2 5}}&nbsp;|&nbsp;{{/^rollGreater() roll2 5}}
        {{/^rollGreater() roll1 5}}

        {{computed::roll2}}

        {{#rollGreater() roll2 5}}
        <span style="font-family: 'Pictos Custom';">t&nbsp;</span>{{computed::expl2}}
        {{/rollGreater() roll2 5}}
        {{/roll2}}

        {{^roll3}}
    </p>{{/roll3}}

    {{#roll3}}
    {{#rollGreater() roll2 5}}</p>
    <p>{{/rollGreater() roll2 5}}

        {{#^rollGreater() roll2 5}}
        {{#rollGreater() roll3 5}}</p>
    <p>{{/rollGreater() roll3 5}}
        {{#^rollGreater() roll3 5}}&nbsp;|&nbsp;{{/^rollGreater() roll3 5}}
        {{/^rollGreater() roll2 5}}

        {{computed::roll3}}

        {{#rollGreater() roll3 5}}
        <span style="font-family: 'Pictos Custom';">t&nbsp;</span>{{computed::expl3}}
        {{/rollGreater() roll3 5}}
        {{/roll3}}

        {{^roll4}}
    </p>{{/roll4}}

    {{#roll4}}
    {{#rollGreater() roll3 5}}</p>
    <p>{{/rollGreater() roll3 5}}

        {{#^rollGreater() roll3 5}}
        {{#rollGreater() roll4 5}}</p>
    <p>{{/rollGreater() roll4 5}}
        {{#^rollGreater() roll4 5}}&nbsp;|&nbsp;{{/^rollGreater() roll4 5}}
        {{/^rollGreater() roll3 5}}

        {{computed::roll4}}

        {{#rollGreater() roll4 5}}
        <span style="font-family: 'Pictos Custom';">t&nbsp;</span>{{computed::expl4}}
        {{/rollGreater() roll4 5}}
        {{/roll4}}

        {{^roll5}}
    </p>{{/roll5}}

    {{#roll5}}
    {{#rollGreater() roll4 5}}</p>
    <p>{{/rollGreater() roll4 5}}

        {{#^rollGreater() roll4 5}}
        {{#rollGreater() roll5 5}}</p>
    <p>{{/rollGreater() roll5 5}}
        {{#^rollGreater() roll5 5}}&nbsp;|&nbsp;{{/^rollGreater() roll5 5}}
        {{/^rollGreater() roll4 5}}

        {{computed::roll5}}

        {{#rollGreater() roll5 5}}
        <span style="font-family: 'Pictos Custom';">t&nbsp;</span>{{computed::expl5}}
        {{/rollGreater() roll5 5}}
        {{/roll5}}

    </p>
</rolltemplate>

<script type="text/worker">
    const outerContainer = $20('div.sheet-outer-container');
    const characterSheet = $20('div.sheet-character-sheet');

    const buttonOrientations = [
        'sheet-button-orientation-left',
        'sheet-button-orientation-right'
    ];

    const backgroundImages = [
        '',
        'sheet-border-line',
        'sheet-background-1',
        'sheet-background-2',
        'sheet-background-3',
        'sheet-background-4',
        'sheet-background-5',
        'sheet-background-6',
        'sheet-background-7',
        'sheet-background-8',
        'sheet-background-9',
    ]

    const clearBackgroundImage = () => backgroundImages.forEach((imageClass) => {
        outerContainer.removeClass(imageClass);
    });

    const clearButtonOrientation = () => buttonOrientations.forEach((orientationClass) => {
        characterSheet.removeClass(orientationClass);
    });

    $20('button.dice-roll').on('click', (evt) => {
        let {
            'data-count': sides,
            'data-explode': explode,
        } = evt.htmlAttributes;

        explode = explode === 'true' ? true : false;
        
        const notation = [];

        for (let i = 0; i < sides; i++) {
            notation.push(`{{roll${i}=[[1d6${explode ? '!' : ''}]]}} {{expl${i}=[[0]]}}`);
        }

        const rollString = `&{template:dice${explode ? '-explode' : ''}} {{name=@{character_name}: ${sides}D6${explode ? '!' : ''}}} ${notation.join(' ')}`;

        startRoll(rollString, (roll) => {
            const results = {};

            for (const resultKey in roll.results) {
                if (resultKey.startsWith('roll')) {
                    const explKey = `expl${resultKey.slice(4)}`;

                    if (roll.results[resultKey].dice.length > 1) {
                        results[resultKey] = roll.results[resultKey].dice.shift();
                        results[explKey] = roll.results[resultKey].dice;
                    } else {
                        results[resultKey] = roll.results[resultKey].dice;
                    }
                }
            }
            
            finishRoll(roll.rollId, results);
        });
    });

    on('sheet:opened', () => {
        getAttrs(['buttonOrientation', 'backgroundImage'], (data) => {
            clearButtonOrientation();
            characterSheet.addClass(data.buttonOrientation);

            clearBackgroundImage();
            outerContainer.addClass(data.backgroundImage);
        });
    });

    on('change:buttonOrientation', (evt) => {
        const { previousValue, newValue } = evt;

        characterSheet.removeClass(previousValue);
        characterSheet.addClass(newValue);
    });

    on('change:backgroundImage', (evt) => {
        const { previousValue, newValue } = evt;

        outerContainer.removeClass(previousValue);
        outerContainer.addClass(newValue);
    });

    on('clicked:help-open', () => $20('.help-modal').removeClass('hidden'));
    on('clicked:help-close', () => $20('.help-modal').addClass('hidden'));

    on('clicked:notes-open', () => $20('.notes-modal').removeClass('hidden'));
    on('clicked:notes-close', () => $20('.notes-modal').addClass('hidden'));
</script>