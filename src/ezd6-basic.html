<link rel="stylesheet" href="ezd6-basic.css" />

<div class="sheet-outer-container">
    <div class="sheet-inner-container sheet-flex-col sheet-col-gap">
        <div class="sheet-flex-row sheet-row-gap sheet-flex-centered">
            <div class="sheet-flex-row sheet-row-gap sheet-flex-centered" style="flex-grow: 1;">
                <div class="sheet-ezd6-logo"></div>
                <h3>Core Sheet</h3>
            </div>

            <button class="help-toggle" type="action" name="act_help-open">
                <span class="icon">?</span>
            </button>
        </div>

        <div class="help-modal hidden">
            <div class="sheet-flex-col sheet-col-gap ${backgroundImage}">
                <div>
                    <div class="sheet-flex-row sheet-flex-centered" style="margin-bottom: 4px;">
                        <div class="sheet-flex-row">
                            <div class="sheet-ezd6-logo"></div>
                            <h3>Core Sheet: Help</h3>
                        </div>

                        <button type="action" name="act_help-close"
                            style="border: none; background-color: rgba(0, 0, 0, 0);">
                            <span class="icon">*</span>
                        </button>
                    </div>

                    <div class="help-body">
                        <div class="sheet-border-group">
                            <h4>Welcome!</h4>
                            <p>
                                Some titles have a tooltip that will appear when you hover your mouse over
                                them.
                            </p>

                            <p>
                                Dice Notation: 1d6 means, roll 1 six-sided die. When you see an exclaimation
                                point, like 1d6!, this means that the die will "explode", which means you
                                get an additional die rolled.

                                However, in all rolls (except Attack) for EZD6, only the highest die is
                                displayed and used. You can hover your mouse cursor over the result to see
                                all the dice rolls.
                            </p>

                            <p>
                            <h5>Sheet Options:</h5>

                            <select name="attr_buttonOrientation" style="width: 172px !important;">
                                <option value="sheet-button-orientation-left">Buttons Left</option>
                                <option value="sheet-button-orientation-right">Buttons Right</option>
                            </select>

                            <select name="attr_backgroundImage" style="width: 172px !important;">
                                <option value="">No Background</option>
                                <option value="sheet-border-line">Border</option>
                                <option value="sheet-background-1">Background 1</option>
                                <option value="sheet-background-2">Background 2</option>
                                <option value="sheet-background-3">Background 3</option>
                                <option value="sheet-background-4">Background 4</option>
                                <option value="sheet-background-5">Background 5</option>
                                <option value="sheet-background-6">Background 6</option>
                                <option value="sheet-background-7">Background 7</option>
                                <option value="sheet-background-8">Background 8</option>
                                <option value="sheet-background-9">Background 9</option>
                            </select>
                            </p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Action, w/Boon, w/Bane Buttons:</h4>
                            <p>
                                An action is anything you want to do that is not Combat or Magick. If you
                                want to climb a tree, influence an NPC, etc.

                                A Boon or Bane is an additional die, added to the roll.
                            </p>
                            <ul>
                                <li><span style="font-weight: bold;">Action</span>: Rolls 1D6! and returns
                                    the single highest die.</li>
                                <li><span style="font-weight: bold;">w/Boon</span>: Rolls 2D6! and returns
                                    the single highest die.</li>
                                <li><span style="font-weight: bold;">w/Bane</span>: Rolls 2D6 and returns
                                    the single lowest die.</li>
                            </ul>
                            <p>
                                Also, you may Shift + Click the w/Boon or w/Bane button to select between 1
                                and 6 Banes or Boons for your roll.
                            </p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Attack, w/Boon, w/Bane Buttons:</h4>
                            <p>
                                An attack is simply attacking an enemy or NPC. The roll results are a little
                                different than an action. The results of the row will show multiple dice if
                                any of them happened to explode. All of the dice displayed for an attack
                                roll are potential strikes, depending on the die value and the armor of the
                                target.

                                A Boon or Bane is an additional die, added to the roll.
                            </p>
                            <ul>
                                <li><span style="font-weight: bold;">Attack</span>: Rolls 1D6! (! =
                                    exploding) and returns all potential strike dice.</li>
                                <li><span style="font-weight: bold;">w/Boon</span>: Rolls 2D6! and returns
                                    all potential strike dice.</li>
                                <li><span style="font-weight: bold;">w/Bane</span>: Rolls 2D6 and returns
                                    all potential strike dice.</li>
                            </ul>
                            <p>
                                Also, you may Shift + Click the w/Boon or w/Bane button to select between 1
                                and 6 Banes or Boons for your roll.
                            </p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>D6, D6!, 2D6, 2D6!, 3D6, 3D6!, 4D6, 4D6!, 5D6, 5D6!, 6D6, 6D6! Buttons:</h4>
                            <p>These are just plain rolls that use the default result of Roll20.</p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Buttons Right/Left Dropdown:</h4>
                            <p>
                                This lets you configure which side the "Buttons" column is positioned, left
                                or right side of the sheet.
                            </p>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Background Dropdown:</h4>
                            <p>This lets you configure the sheet background. Possible options are:</p>
                            <ul>
                                <li><span style="font-weight: bold;">No Background</span>: No background
                                    images or borders.</li>
                                <li><span style="font-weight: bold;">Border</span>: Just a clean border, no
                                    background image.</li>
                                <li><span style="font-weight: bold;">Background (1-9)</span>: Any of 9
                                    beautiful background images by Mathew Halstead.</li>
                            </ul>
                        </div>

                        <div class="sheet-border-group">
                            <h4>Credits:</h4>
                            <p>
                                First, let's thank DM_Scotty for creating one of the best TT RPGs available
                                today!
                            </p>
                            <ul>
                                <li><span style="font-weight: bold;">John Wakley</span>: Code and Design.
                                </li>
                                <li><span style="font-weight: bold;">Mathew Halstead</span>: Art and Design.
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sheet-character-sheet sheet-row-gap ${buttonOrientation}">
            <div class="sheet-flex-col sheet-col-gap">
                <div class="sheet-flex-col sheet-border-group">
                    <div class="sheet-input-field">
                        <label for="character_name">Name:</label>
                        <input id="character_name" type="text" name="attr_character_name" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="species">Species:</label>
                        <input id="species" type="text" name="attr_character_species" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="path">Hero Path:</label>
                        <input id="path" type="text" name="attr_character_hero_path" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="aspect_1">Aspect 1:</label>
                        <input id="aspect_1" type="text" name="attr_character_aspect_1" />
                    </div>

                    <div class="sheet-input-field">
                        <label for="aspect_1">Aspect 2:</label>
                        <input id="aspect_1" type="text" name="attr_character_aspect_2" />
                    </div>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="hero_path_features">Hero Path Features:</label>
                    <textarea id="hero_path_features" class="small" name="attr_character_hero_path_features" rows="4"
                        cols="100"></textarea>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="magick" title="Sorcery Circle(s), Scrolls, Potions, etc...">Magick:</label>
                    <textarea id="magick" class="small" name="attr_character_magick" rows="4" cols="100"></textarea>
                </div>
            </div>

            <div class="sheet-flex-col sheet-col-gap" style="align-content: start;">
                <div class="sheet-flex-col sheet-flex-centered sheet-border-group sheet-col-gap"
                    style="padding: 4px 4px !important;">
                    <div class="sheet-flex-row sheet-flex-centered sheet-row-gap">
                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="health" style="text-align: center;">Health:</label>
                            <input id="health" class="sheet-single-digit" type="number" name="attr_character_health" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="karma" style="text-align: center;">Karma:</label>
                            <input id="karma" class="sheet-single-digit" type="number" name="attr_character_karma" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="armor_save" style="text-align: center;"> Armor Save:</label>
                            <input id="armor_save" class="sheet-single-digit" type="number" name="attr_armor_save" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="hero_die" style="text-align: center;">Hero Die:</label>
                            <input id="hero_die" class="sheet-single-digit" type="number" name="attr_hero_die" />
                        </div>

                        <div class="sheet-flex-col sheet-flex-centered sheet-attr-group">
                            <label for="miraculous_save" style="text-align: center;">Miraculous Save:</label>
                            <input id="miraculous_save" class="sheet-single-digit" type="number"
                                name="attr_miraculous_save" />
                        </div>
                    </div>

                    <div class="sheet-flex-col sheet-flex-centered">
                        <label for="description"
                            style="font-size: 1rem; line-height: 1.2rem; margin-bottom: 2px !important;">
                            Description (Looks, Demeanor, Quirks, Flaws):
                        </label>
                        <textarea id="description" class="small" name="attr_character_description" rows="3" cols="100"
                            style="height: 64px !important;"></textarea>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="inclinations">Inclinations:</label>
                    <textarea id="inclinations" class="small" name="attr_character_inclinations" rows="4"
                        cols="100"></textarea>
                </div>

                <div class="sheet-flex-col sheet-flex-centered sheet-border-group">
                    <label for="equipment" title="Wealth, Weapons, Armor, Gear, etc.">Equipment:</label>
                    <textarea id="equipment" class="small" name="attr_character_equipment" rows="4"
                        cols="100"></textarea>
                </div>
            </div>

            <div class="sheet-flex-col sheet-col-gap sheet-button-section">
                <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                    <button class="dice-roll" data-type="action">Action</button>

                    <div class="sheet-flex-row" style="justify-content: space-between;">
                        <button class="dice-roll" data-type="action" data-boons="1">w/Boon</button>
                        <button class="dice-roll" data-type="action" data-banes="1">w/Bane</button>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                    <button class="dice-roll" data-type="attack">Attack</button>

                    <div class="sheet-flex-row" style="justify-content: space-between;">
                        <button class="dice-roll" data-type="attack" data-boons="1">w/Boon</button>
                        <button class="dice-roll" data-type="attack" data-banes="1">w/Bane</button>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                    <button class="dice-roll" data-type="magick">Magick</button>
                    <button class="dice-roll" data-type="miracle">Miracle</button>
                </div>

                <div class="sheet-flex-row sheet-row-gap">
                    <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                        <label>Regular:</label>
                        <div class="sheet-flex-row sheet-row-gap">
                            <button class="dice-roll" data-type="dice" data-count="1"
                                data-exploding="false">1D6</button>
                            <button class="dice-roll" data-type="dice" data-count="2"
                                data-exploding="false">2D6</button>
                        </div>

                        <div class="sheet-flex-row sheet-row-gap">
                            <button class="dice-roll" data-type="dice" data-count="3"
                                data-exploding="false">3D6</button>
                            <button class="dice-roll" data-type="dice" data-count="4"
                                data-exploding="false">4D6</button>
                        </div>

                        <div class="sheet-flex-row sheet-row-gap">
                            <button class="dice-roll" data-type="dice" data-count="5"
                                data-exploding="false">5D6</button>
                            <button class="dice-roll" data-type="dice" data-count="6"
                                data-exploding="false">6D6</button>
                        </div>
                    </div>

                    <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                        <label>Exploding:</label>
                        <div class="sheet-flex-row sheet-row-gap">
                            <button class="dice-roll" data-type="dice" data-count="1"
                                data-exploding="true">1D6!</button>
                            <button class="dice-roll" data-type="dice" data-count="2"
                                data-exploding="true">2D6!</button>
                        </div>

                        <div class="sheet-flex-row sheet-row-gap">
                            <button class="dice-roll" data-type="dice" data-count="3"
                                data-exploding="true">3D6!</button>
                            <button class="dice-roll" data-type="dice" data-count="4"
                                data-exploding="true">4D6!</button>
                        </div>

                        <div class="sheet-flex-row sheet-row-gap">
                            <button class="dice-roll" data-type="dice" data-count="5"
                                data-exploding="true">5D6!</button>
                            <button class="dice-roll" data-type="dice" data-count="6"
                                data-exploding="true">6D6!</button>
                        </div>
                    </div>
                </div>

                <div class="sheet-flex-col sheet-col-gap sheet-border-group">
                    <button class="notes-toggle" type="action" name="act_notes-open">Notes</button>

                    <div class="notes-modal hidden">
                        <div class="sheet-flex-col ${backgroundImage}">
                            <div class="sheet-flex-col">
                                <div class="sheet-flex-row sheet-flex-centered" style="margin-bottom: 4px;">
                                    <div class="sheet-flex-row">
                                        <div class="sheet-ezd6-logo"></div>
                                        <h3>Core Sheet: Notes</h3>
                                    </div>

                                    <button type="action" name="act_notes-close"
                                        style="border: none; background-color: rgba(0, 0, 0, 0);">
                                        <span class="icon">*</span>
                                    </button>
                                </div>

                                <div class="notes-body sheet-border-group" style="flex-grow: 1;">
                                    <textarea class="large" name="attr_notes" rows="4" cols="200"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<rolltemplate class="sheet-rolltemplate-action">
    <h3>{{name}}: {{Roll}}</h3>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-computed">
    <h3>{{name}}: {{computed::Roll}}</h3>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-dice">
    <h3>{{name}}: {{computed::Roll}}</h3>
</rolltemplate>

<script type="text/worker">
    const outerContainer = $20('div.sheet-outer-container');
    const characterSheet = $20('div.sheet-character-sheet');

    const buttonOrientations = [
        'sheet-button-orientation-left',
        'sheet-button-orientation-right'
    ];

    const backgroundImages = [
        '',
        'sheet-border-line',
        'sheet-background-1',
        'sheet-background-2',
        'sheet-background-3',
        'sheet-background-4',
        'sheet-background-5',
        'sheet-background-6',
        'sheet-background-7',
        'sheet-background-8',
        'sheet-background-9',
    ]

    const clearBackgroundImage = () => backgroundImages.forEach((imageClass) => {
        outerContainer.removeClass(imageClass);
    });

    const clearButtonOrientation = () => buttonOrientations.forEach((orientationClass) => {
        characterSheet.removeClass(orientationClass);
    });

    const rqBoons = '?{Number of Boons|1|2|3|4|5|6}';
    const rqBanes = '?{Number of Banes|1|2|3|4|5|6}';
    const rqMagick = '?{Power Level|1|2|3|4|5|6}';
    const rqMiracle = '?{Miracle|1|2|3|4|5|6}';

    const rollAttack = (params = { banes: 0, boones: 0, shiftKey: false }) => {
        const { banes, boons, shiftKey } = params;

        let rollString = '&{template:computed} ';

        if (banes > 0) {
            rollString += (
                `{{name=Attack, with ${shiftKey ? rqBanes : banes} Banes}} `
                + `{{Roll=[[(1 + ${shiftKey ? rqBanes : banes})d6!kl1]]}}`
            );
        } else if (boons > 0) {
            rollString += (
                `{{name=Attack, with ${shiftKey ? rqBoons : boons} Boons}} `
                + `{{Roll=[[[[1 + ${shiftKey ? rqBoons : boons}]]d6!kh1]]}}`
            );
        } else {
            rollString += '{{name=Attack}} {{Roll=[[1d6!kh1]]}}';
        }

        startRoll(
            rollString,
            (roll) => {
                // console.debug('*** rollAttack: roll:', roll);
                
                if (banes === 0) {
                    const dice = [...roll.results.Roll.dice];
                    const count = dice.length;

                    const native = [];
                    const additional = [];

                    while (dice.length > 0) {
                        let current = dice.shift();
                        native.push(current);

                        while (current === 6 && dice.length > 0) {
                            current = dice.shift();
                            additional.push(current);
                        }
                    }

                    native.sort((a, b) => (b - a));

                    finishRoll(roll.rollId, { Roll: [native[0], ...additional] });
                } else {
                    finishRoll(roll.rollId, { Roll: roll.results.Roll.result });
                }
            }
        );
    };

    const rollAction = (params = {
        banes: 0,
        boones: 0,
        shiftKey: false,
    }) => {
        const { banes, boons, shiftKey } = params;

        let rollString = '&{template:action} ';

        if (banes > 0) {
            rollString += (
                `{{name=Action, with ${shiftKey ? rqBanes : banes} Banes}} `
                + `{{Roll=[[(1 + ${shiftKey ? rqBanes : banes})d6!kl1]]}}`
            );
        } else if (boons > 0) {
            rollString += (
                `{{name=Action, with ${shiftKey ? rqBoons : boons} Boons}} `
                + `{{Roll=[[(1 + ${shiftKey ? rqBoons : boons})d6!kh1]]}}`
            );
        } else {
            rollString += '{{name=Action}} {{Roll=[[1d6!kh1]]}}';
        }

        startRoll(rollString, (roll) => finishRoll(roll.rollId, { Roll: roll.results.Roll.result }));
    };

    const rollDice = (params = {
        count: 1,
        exploding: false,
    }) => {
        const { count, exploding } = params;
        const notation = `${count}d6${exploding ? '!' : ''}`;

        let rollString = `&{template:dice} {{name=${notation.toUpperCase()}}} {{Roll=[[${notation}]]}}`;

        startRoll(rollString, (roll) => {
            const Roll = roll.results.Roll.dice.sort((a, b) => (b - a));
            finishRoll(roll.rollId, { Roll })
        });
    };

    const rollMagick = () => {
        const notation = `${rqMagick}d6!`;

        startRoll(
            `&{template:dice} {{name=Magick: PowerLevel: ${rqMagick}}} {{Roll=[[${rqMagick}d6!]]}}`,
            (roll) => {
                const Roll = roll.results.Roll.dice.sort((a, b) => (b - a));
                finishRoll(roll.rollId, { Roll })
            }
        );
    };

    const rollMiracle = () => {
        const notation = `${rqMagick}d6!`;

        startRoll(
            `&{template:dice} {{name=Miracle: ${rqMiracle}}} {{Roll=[[${rqMiracle}d6!]]}}`,
            (roll) => {
                const Roll = roll.results.Roll.dice.sort((a, b) => (b - a));
                finishRoll(roll.rollId, { Roll })
            }
        );
    };

    $20('button.dice-roll').on('click', (evt) => {
        const { altKey, ctrlKey, metaKey, shiftKey } = evt;

        let {
            'data-type': type,
            'data-boons': dataBoons,
            'data-banes': dataBanes,
            'data-count': dataCount,
            'data-exploding': dataExploding,
        } = evt.htmlAttributes;

        dataBoons = parseInt(dataBoons);
        if (isNaN(dataBoons)) dataBoons = 0;

        dataBanes = parseInt(dataBanes);
        if (isNaN(dataBanes)) dataBanes = 0;

        const boons = dataBoons;
        const banes = dataBanes;

        let rollString

        switch (type) {
            case 'action':
                rollAction({ banes, boons, shiftKey });
                break;
            case 'attack':
                rollAttack({ banes, boons, shiftKey });
                break;
            case 'magick':
                rollMagick();
                break;
            case 'miracle':
                rollMiracle();
                break;
            default:
                dataCount = parseInt(dataCount);
                if (isNaN(dataCount)) dataCount = 1;

                const exploding = (dataExploding === 'true') ? true : false;

                rollDice({ count: dataCount, exploding })
                break;
        }
    });

    on('sheet:opened', () => {
        getAttrs(['buttonOrientation', 'backgroundImage'], (data) => {
            clearButtonOrientation();
            characterSheet.addClass(data.buttonOrientation);

            clearBackgroundImage();
            outerContainer.addClass(data.backgroundImage);
        });
    });

    on('change:buttonOrientation', (evt) => {
        const { previousValue, newValue } = evt;

        characterSheet.removeClass(previousValue);
        characterSheet.addClass(newValue);
    });

    on('change:backgroundImage', (evt) => {
        const { previousValue, newValue } = evt;

        outerContainer.removeClass(previousValue);
        outerContainer.addClass(newValue);
    });

    on('clicked:help-open', () => $20('.help-modal').removeClass('hidden'));
    on('clicked:help-close', () => $20('.help-modal').addClass('hidden'));

    on('clicked:notes-open', () => $20('.notes-modal').removeClass('hidden'));
    on('clicked:notes-close', () => $20('.notes-modal').addClass('hidden'));
</script>